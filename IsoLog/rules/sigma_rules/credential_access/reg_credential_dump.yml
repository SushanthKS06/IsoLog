title: Registry Hive Save for Credential Access
id: reg_hive_save
status: experimental
description: Detects saving of SAM, SECURITY, or SYSTEM registry hives via reg.exe
author: IsoLog
references:
    - https://attack.mitre.org/techniques/T1003/002/
logsource:
    category: process_creation
    product: windows
detection:
    selection_reg_sam:
        EventID:
            - 4688
            - 1
        CommandLine|contains:
            - 'save hklm\\sam'
            - 'save hklm\\security'
            - 'save hklm\\system'
            - 'save HKLM\\SAM'
            - 'save HKLM\\SECURITY'
            - 'save HKLM\\SYSTEM'
            - 'export hklm\\sam'
            - 'export hklm\\security'
            - 'export hklm\\system'
    selection_reg_exe:
        Image|endswith:
            - '\\reg.exe'
        CommandLine|contains:
            - "sam"
            - "SAM"
            - "security"
            - "SECURITY"
    condition: selection_reg_sam or selection_reg_exe
falsepositives:
    - System backup
level: critical
tags:
    - attack.credential_access
    - attack.t1003
    - attack.t1003.002
